name: Publish Allure Report

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Run tests if available
        run: |
          if [ -d "src/test" ] && [ $(find src/test -name "*.java" | wc -l) -gt 0 ]; then
            ./gradlew clean test --rerun-tasks || true
          else
            echo "No test files found"
            mkdir -p build/allure-results
          fi
        continue-on-error: true

      - name: Install Allure
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -xzf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/
          sudo ln -sf /opt/allure-2.27.0/bin/allure /usr/local/bin/allure

      - name: Generate report
        run: |
          mkdir -p _site
          
          if [ -d "build/allure-results" ] && [ $(find build/allure-results -name "*.json" | wc -l) -gt 0 ]; then
            allure generate build/allure-results -o _site --clean
          else
            echo '<!DOCTYPE html>
            <html>
            <head>
              <title>Allure Report</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; margin: 0 auto; }
                .success { color: green; font-weight: bold; }
              </style>
            </head>
            <body>
              <div class="container">
                <h1>âœ… Allure Report Setup Complete</h1>
                <p class="success">Web UI Automation Practice</p>
                <p>GitHub Actions workflow is working correctly.</p>
                <p>Add test files to see detailed reports here.</p>
              </div>
            </body>
            </html>' > _site/index.html
          fi
          
          echo "Report created at _site/"
          ls -la _site/

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4