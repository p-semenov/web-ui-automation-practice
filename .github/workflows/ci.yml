
  name: Publish Allure Report

  on:
    push:
      branches: [ "main" ]
    pull_request:
      branches: [ "main" ]
    workflow_dispatch:

  permissions:
    contents: write
    pages: write
    id-token: write

  jobs:
    build-and-deploy:
      runs-on: ubuntu-latest

      # Убедимся, что у нас есть переменные окружения
      env:
        GRADLE_OPTS: "-Dorg.gradle.daemon=false"

      steps:
        # 1. Клонируем код
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0  # Получаем всю историю для Allure history

        # 2. Устанавливаем Java
        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'

        # 3. Даём права на выполнение gradlew
        - name: Make gradlew executable
          run: chmod +x gradlew

        # 4. Запускаем тесты
        - name: Run tests with Gradle
          run: ./gradlew clean test
          continue-on-error: true  # Продолжаем даже если тесты упали

        # 5. УСТАНАВЛИВАЕМ ALLURE БЕЗ СИМЛИНКОВ В /usr/bin
        - name: Setup Allure
          run: |
            # Скачиваем Allure без установки в системные папки
            wget -q -O allure-2.27.0.tgz https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
            tar -xzf allure-2.27.0.tgz -C /opt/
            # Добавляем в PATH без создания симлинков
            echo "/opt/allure-2.27.0/bin" >> $GITHUB_PATH
            # Проверяем установку
            which allure || echo "Allure not in PATH"

        # 6. Проверяем, что результаты тестов существуют
        - name: Check Allure results exist
          run: |
            if [ -d "build/allure-results" ]; then
              echo "Allure results found:"
              ls -la build/allure-results/ | head -10
              echo "Total files: $(find build/allure-results -name "*.json" | wc -l)"
            else
              echo "WARNING: No allure-results folder found!"
              echo "Current build directory contents:"
              find build -type f -name "*.json" 2>/dev/null || echo "No JSON files found"
            fi

        # 7. Генерируем Allure отчет
        - name: Generate Allure Report
          run: |
            # Создаем папку для отчета
            mkdir -p _site
            
            # Если есть результаты - генерируем отчет
            if [ -d "build/allure-results" ] && [ $(find build/allure-results -name "*.json" 2>/dev/null | wc -l) -gt 0 ]; then
              echo "Generating Allure report..."
              allure generate build/allure-results -o _site --clean
              echo "Report generated successfully"
            else
              echo "No Allure results found, creating empty report"
              echo '<!DOCTYPE html><html><head><title>Allure Report</title></head><body><h1>No test results available</h1><p>Run tests to see the report here.</p></body></html>' > _site/index.html
            fi

        # 8. Настраиваем GitHub Pages
        - name: Setup GitHub Pages
          uses: actions/configure-pages@v4

        # 9. Загружаем отчет как артефакт (для отладки)
        - name: Upload report artifact for debugging
          uses: actions/upload-artifact@v4
          with:
            name: allure-report-debug
            path: _site
            retention-days: 7

        # 10. Публикуем отчет на GitHub Pages
        - name: Upload report to Pages
          uses: actions/upload-pages-artifact@v3
          with:
            path: '_site'

        - name: Deploy to GitHub Pages
          id: deployment
          uses: actions/deploy-pages@v4